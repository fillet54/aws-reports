{% extends "layout.html" %}

{% block title %}{{ brand.name }} â€“ Brand Index{% endblock %}

{% block content %}
  <div class="flex flex-wrap items-start justify-between gap-4 mb-4">
    <div>
      <h1 class="text-3xl font-bold mb-2">{{ brand.name }}</h1>
      <div class="flex flex-wrap gap-2">
        <a class="btn btn-ghost btn-sm" href="{{ url_for('index') }}">Change brand</a>
        <a class="btn btn-ghost btn-sm" href="{{ url_for('edit_brand', brand_id=brand.id) }}">
          Edit brand
        </a>
        <a class="btn btn-ghost btn-sm" href="{{ url_for('asin_meta_index', brand_id=brand.id) }}">
          Edit ASINs 
        </a>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <div class="join join-sm">
        <button class="btn btn-sm join-item btn-primary channel-select" data-channel="US">US ðŸ‡ºðŸ‡¸</button>
        <button class="btn btn-sm join-item btn-outline channel-select" data-channel="CANADA">Canada ðŸ‡¨ðŸ‡¦</button>
      </div>
      <div class="flex flex-col items-end gap-1">
        {% if latest_updated_date %}
          <div class="text-xs text-base-content/70 text-right min-w-[120px]">
            <p class="font-semibold text-base-content whitespace-nowrap">Last imported</p>
            <p class="whitespace-nowrap">{{ latest_updated_date }}</p>
          </div>
        {% endif %}
        <button class="btn btn-primary btn-sm" onclick="importDialog.showModal()">
          Import orders
        </button>
      </div>
    </div>
  </div>

  <p class="mb-4 text-sm text-base-content/70">
    Brand ID: <code>{{ brand.id }}</code>
  </p>

  {% if channel_sales_summary %}
    <div id="channel-cards" class="mb-6 space-y-2" data-default-channel="US">
      <div class="grid gap-4 md:grid-cols-3">
        <div class="card bg-base-100 shadow">
          <div class="card-body">
            <p class="text-sm text-base-content/70">Year to date</p>
            <h3 class="text-2xl font-semibold" data-field="ytd-amount"></h3>
            <p class="text-xs text-base-content/60" data-field="ytd-range"></p>
            <p class="text-xs font-semibold" data-field="ytd-change"></p>
          </div>
        </div>
        <div class="card bg-base-100 shadow">
          <div class="card-body">
            <p class="text-sm text-base-content/70">Month to date</p>
            <h3 class="text-2xl font-semibold" data-field="mtd-amount"></h3>
            <p class="text-xs text-base-content/60" data-field="mtd-range"></p>
            <p class="text-xs font-semibold" data-field="mtd-change"></p>
          </div>
        </div>
        <div class="card bg-base-100 shadow">
          <div class="card-body">
            <p class="text-sm text-base-content/70">Current week</p>
            <h3 class="text-2xl font-semibold" data-field="week-amount"></h3>
            <p class="text-xs text-base-content/60" data-field="week-range"></p>
            <p class="text-xs font-semibold" data-field="week-change"></p>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <div class="card bg-base-100 shadow mb-6">
    <div class="card-body space-y-4">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="card-title">Monthly performance</h2>
          <p class="text-sm text-base-content/70">Units (bars) vs. sales (line) for the year.</p>
        </div>
      </div>
      <div class="h-72">
        <canvas id="channelChart" class="w-full h-full"></canvas>
      </div>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-4 space-y-2">
        {% for category, message in messages %}
          <div class="alert {{ 'alert-error' if category == 'error' else 'alert-success' }}">
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="space-y-6">
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h2 class="card-title">Brand dashboard</h2>
            <p class="text-sm text-base-content/70">Quick links and stats for {{ brand.name }}.</p>
          </div>
          <div class="join join-sm">
            <button
              class="report-toggle btn btn-sm join-item btn-primary"
              data-report="monthly"
              hx-get="{{ url_for('brand_reports', brand_id=brand.id, partial=1, channel='US') }}"
              hx-target="#report-panel"
              hx-swap="innerHTML"
            >
              Monthly
            </button>
            <button
              class="report-toggle btn btn-sm join-item btn-outline"
              data-report="weekly"
              hx-get="{{ url_for('brand_weekly_reports', brand_id=brand.id, partial=1, channel='US') }}"
              hx-target="#report-panel"
              hx-swap="innerHTML"
            >
              Weekly
            </button>
          </div>
        </div>

        <div
          id="report-panel"
          data-monthly-url="{{ url_for('brand_reports', brand_id=brand.id) }}"
          data-weekly-url="{{ url_for('brand_weekly_reports', brand_id=brand.id) }}"
          data-active-report="monthly"
          hx-get="{{ url_for('brand_reports', brand_id=brand.id, partial=1, channel='US') }}"
          hx-trigger="load"
          hx-swap="innerHTML"
        >
          <div class="text-sm text-base-content/70">Loading reportâ€¦</div>
        </div>
      </div>
    </div>
  </div>

  <dialog id="importDialog" class="modal">
    <div class="modal-box max-w-xl">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
      </form>
      <h3 class="font-bold text-lg mb-2">Import orders report</h3>
      <p class="text-sm text-base-content/70 mb-4">
        Upload a CSV or TXT orders report for this brand. The data will be imported into
        the SQLite database, and the original file will be archived.
      </p>
      <form
        method="post"
        action="{{ url_for('import_orders_report', brand_id=brand.id) }}"
        enctype="multipart/form-data"
        class="space-y-4"
      >
        <label class="form-control w-full">
          <div class="label">
            <span class="label-text font-semibold">Orders report (.csv or .txt)</span>
          </div>
          <input
            type="file"
            name="report_file"
            accept=".csv,text/csv,.txt,text/plain"
            class="file-input file-input-bordered w-full"
            required
          >
        </label>
        <div class="modal-action">
          <button type="button" class="btn btn-ghost" onclick="importDialog.close()">Cancel</button>
          <button class="btn btn-primary" type="submit">
            Import report
          </button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('htmx:afterSwap', function(evt) {
    if (!evt.target || evt.target.id !== 'report-panel') return;
    const panel = document.getElementById('report-panel');
    const buttons = document.querySelectorAll('.report-toggle');
    const isWeekly = evt.detail.xhr.responseURL && evt.detail.xhr.responseURL.includes('/reports/weekly');
    if (panel) {
      panel.dataset.activeReport = isWeekly ? 'weekly' : 'monthly';
    }
    buttons.forEach(btn => {
      const wantsWeekly = btn.textContent.trim().toLowerCase() === 'weekly';
      if (wantsWeekly === isWeekly) {
        btn.classList.add('btn-primary');
        btn.classList.remove('btn-outline');
      } else {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline');
      }
    });
  });

  (function initChannelUI() {
    const chartCtx = document.getElementById('channelChart');
    const cardsContainer = document.getElementById('channel-cards');
    const reportPanel = document.getElementById('report-panel');
    const monthlyBtn = document.querySelector('.report-toggle[data-report="monthly"]');
    const weeklyBtn = document.querySelector('.report-toggle[data-report="weekly"]');
    if (!chartCtx || !cardsContainer) return;

    const chartData = {{ channel_chart_data|tojson }};
    const channelSales = {{ channel_sales_summary|tojson }};
    const labels = chartData?.labels || [];
    const currentYear = chartData?.year;
    const previousYear = chartData?.previous_year;
    const channels = chartData?.channels || {};
    let currentChannel = channels["US"] ? "US" : Object.keys(channels)[0] || "US";

    let chartInstance = null;
    const monthlyBase = reportPanel?.dataset.monthlyUrl || '';
    const weeklyBase = reportPanel?.dataset.weeklyUrl || '';
    let monthlyUrlState = null;
    let weeklyUrlState = null;
    let currentMonth = null;
    let currentWeek = null;
    let currentStartDate = null;
    let currentEndDate = null;
    let activeReport = reportPanel?.dataset.activeReport || 'monthly';

    function datasetFor(channelKey) {
      const data = channels[channelKey] || {
        units: Array(labels.length).fill(0),
        sales: Array(labels.length).fill(0),
        previous_sales: Array(labels.length).fill(0),
      };
      return {
        units: data.units,
        sales: data.sales,
        previousSales: data.previous_sales,
      };
    }

    function render(channelKey) {
      const data = datasetFor(channelKey);
      if (!chartInstance) {
        chartInstance = new Chart(chartCtx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                type: 'bar',
                label: `Units${currentYear ? ` (${currentYear})` : ''}`,
                data: data.units,
                backgroundColor: 'rgba(59, 130, 246, 0.4)',
                borderColor: 'rgba(37, 99, 235, 1)',
                borderWidth: 1,
                yAxisID: 'yUnits',
              },
              {
                type: 'line',
                label: `Sales${currentYear ? ` (${currentYear})` : ''}`,
                data: data.sales,
                borderColor: 'rgba(16, 185, 129, 1)',
                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                tension: 0.3,
                fill: false,
                yAxisID: 'ySales',
              },
              {
                type: 'line',
                label: `Sales${previousYear ? ` (${previousYear})` : ' (prev year)'}`,
                data: data.previousSales,
                borderColor: 'rgba(156, 163, 175, 1)',
                backgroundColor: 'rgba(156, 163, 175, 0.15)',
                borderDash: [6, 4],
                tension: 0.3,
                fill: false,
                yAxisID: 'ySales',
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: {
              yUnits: {
                type: 'linear',
                position: 'left',
                title: { display: true, text: 'Units' },
              },
              ySales: {
                type: 'linear',
                position: 'right',
                title: { display: true, text: 'Sales' },
                grid: { drawOnChartArea: false },
              },
            },
            plugins: {
              legend: { position: 'bottom' },
            },
          },
        });
      } else {
        chartInstance.data.datasets[0].data = data.units;
        chartInstance.data.datasets[1].data = data.sales;
        chartInstance.data.datasets[2].data = data.previousSales;
        chartInstance.update();
      }
    }

    function buildUrl(base, params) {
      if (!base) return '';
      const url = new URL(base, window.location.origin);
      Object.entries(params || {}).forEach(([k, v]) => url.searchParams.set(k, v));
      return url.pathname + url.search;
    }

    function mergeUrl(baseUrlState, fallbackBase, extraParams) {
      const url = baseUrlState ? new URL(baseUrlState, window.location.origin) : new URL(fallbackBase, window.location.origin);
      Object.entries(extraParams || {}).forEach(([k, v]) => {
        if (v === null || v === undefined || v === '') {
          url.searchParams.delete(k);
        } else {
          url.searchParams.set(k, v);
        }
      });
      return url.pathname + url.search;
    }

    function updateHistory() {
      const params = new URLSearchParams(window.location.search);
      params.set('channel', currentChannel);
      params.set('report', activeReport);
      if (activeReport === 'monthly' && currentMonth) {
        params.set('month', currentMonth);
        params.delete('week');
      } else if (activeReport === 'weekly') {
        if (currentWeek) params.set('week', currentWeek);
        if (currentStartDate) params.set('start_date', currentStartDate);
        if (currentEndDate) params.set('end_date', currentEndDate);
        params.delete('month');
      }
      const newUrl = `${window.location.pathname}?${params.toString()}`;
      window.history.replaceState({}, '', newUrl);
    }

    function refreshReportPanel() {
      if (!reportPanel) return;
      activeReport = reportPanel.dataset.activeReport || 'monthly';
      const monthlyUrl = mergeUrl(monthlyUrlState, monthlyBase, { partial: 1, channel: currentChannel, month: currentMonth });
      const weeklyUrl = mergeUrl(weeklyUrlState, weeklyBase, {
        partial: 1,
        channel: currentChannel,
        week: currentWeek,
        start_date: currentStartDate,
        end_date: currentEndDate,
      });
      if (monthlyBtn && monthlyUrl) monthlyBtn.setAttribute('hx-get', monthlyUrl);
      if (weeklyBtn && weeklyUrl) weeklyBtn.setAttribute('hx-get', weeklyUrl);
      const targetUrl = activeReport === 'weekly' ? weeklyUrl : monthlyUrl;
      if (targetUrl) {
        htmx.ajax('GET', targetUrl, '#report-panel');
        updateHistory();
      }
    }

    function setActive(channelKey) {
      currentChannel = channelKey;
      document.querySelectorAll('.channel-select').forEach((btn) => {
        const isActive = btn.dataset.channel === channelKey;
        btn.classList.toggle('btn-primary', isActive);
        btn.classList.toggle('btn-outline', !isActive);
      });
      render(channelKey);
      renderCards(channelKey);
      refreshReportPanel();
    }

    function formatChange(change) {
      if (change === null || change === undefined) return '';
      const dirUp = change > 0;
      const dirFlat = change === 0;
      const arrow = dirFlat ? 'â†’' : dirUp ? 'â–²' : 'â–¼';
      const color = dirFlat ? 'text-base-content/60' : dirUp ? 'text-success' : 'text-error';
      return { text: `${arrow} ${change.toFixed(1)}% vs LY`, className: color };
    }

    function renderCards(channelKey) {
      const data = channelSales[channelKey] || {
        currency: channelKey === 'CANADA' ? 'CAD' : 'USD',
        ytd: 0, mtd: 0, week: 0,
        ytd_start: '', mtd_start: '', week_start: '', today: '',
        ytd_change: null, mtd_change: null, week_change: null,
      };
      const setField = (selector, value, className) => {
        const el = cardsContainer.querySelector(`[data-field="${selector}"]`);
        if (el) {
          el.textContent = value;
          if (className) {
            el.className = `text-xs font-semibold ${className}`;
          }
        }
      };
      const ytdChange = formatChange(data.ytd_change);
      const mtdChange = formatChange(data.mtd_change);
      const weekChange = formatChange(data.week_change);
      setField('ytd-amount', `${data.currency} ${Number(data.ytd || 0).toFixed(2)}`);
      setField('mtd-amount', `${data.currency} ${Number(data.mtd || 0).toFixed(2)}`);
      setField('week-amount', `${data.currency} ${Number(data.week || 0).toFixed(2)}`);
      setField('ytd-range', `${data.ytd_start} â†’ ${data.today}`);
      setField('mtd-range', `${data.mtd_start} â†’ ${data.today}`);
      setField('week-range', `${data.week_start} â†’ ${data.today}`);
      setField('ytd-change', ytdChange.text || '', ytdChange.className);
      setField('mtd-change', mtdChange.text || '', mtdChange.className);
      setField('week-change', weekChange.text || '', weekChange.className);
    }

    document.querySelectorAll('.channel-select').forEach((btn) => {
      btn.addEventListener('click', () => setActive(btn.dataset.channel));
    });

    document.addEventListener('htmx:afterSwap', (evt) => {
      if (!evt.target || evt.target.id !== 'report-panel') return;
      const respUrl = evt.detail?.xhr?.responseURL;
      if (respUrl) {
        const url = new URL(respUrl, window.location.origin);
        const isWeekly = url.pathname.includes('/reports/weekly');
        reportPanel.dataset.activeReport = isWeekly ? 'weekly' : 'monthly';
        if (isWeekly) {
          weeklyUrlState = url;
          currentWeek = url.searchParams.get('week') || currentWeek;
          currentStartDate = url.searchParams.get('start_date') || currentStartDate;
          currentEndDate = url.searchParams.get('end_date') || currentEndDate;
        } else {
          monthlyUrlState = url;
          currentMonth = url.searchParams.get('month') || currentMonth;
        }
      }
      const monthEl = evt.target.querySelector('[data-selected-month]');
      if (monthEl && monthEl.dataset.selectedMonth) {
        currentMonth = monthEl.dataset.selectedMonth;
      }
      const weekEl = evt.target.querySelector('[data-selected-week]');
      if (weekEl && weekEl.dataset.selectedWeek) {
        currentWeek = weekEl.dataset.selectedWeek;
      }
      updateHistory();
    });

    setActive(currentChannel);
  })();
</script>
{% endblock %}
{% endblock %}
