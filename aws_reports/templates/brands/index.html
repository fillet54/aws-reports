{% extends "layout.html" %}

{% block title %}{{ brand.name }} â€“ Brand Index{% endblock %}

{% block content %}
  <div class="flex flex-wrap items-start justify-between gap-4 mb-4">
    <div>
      <h1 class="text-3xl font-bold mb-2">{{ brand.name }}</h1>
      <div class="flex flex-wrap gap-2">
        <a class="btn btn-ghost btn-sm" href="{{ url_for('index') }}">Change brand</a>
        <a class="btn btn-ghost btn-sm" href="{{ url_for('edit_brand', brand_id=brand.id) }}">
          Edit brand
        </a>
        <a class="btn btn-ghost btn-sm" href="{{ url_for('asin_meta_index', brand_id=brand.id) }}">
          Edit ASINs 
        </a>
      </div>
    </div>
    <div class="flex flex-col items-end gap-1">
      {% if latest_updated_date %}
        <div class="text-xs text-base-content/70 text-right min-w-[120px]">
          <p class="font-semibold text-base-content whitespace-nowrap">Last imported</p>
          <p class="whitespace-nowrap">{{ latest_updated_date }}</p>
        </div>
      {% endif %}
      <button class="btn btn-primary btn-sm" onclick="importDialog.showModal()">
        Import orders
      </button>
    </div>
  </div>

  <p class="mb-4 text-sm text-base-content/70">
    Brand ID: <code>{{ brand.id }}</code>
  </p>

  {% if channel_sales_summary %}
    {% for channel, summary in channel_sales_summary.items() %}
      <div class="mb-6 space-y-2">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">
            {{ 'US' if channel == 'US' else 'Canada' }} ({{ summary.currency }})
          </h2>
        </div>
        <div class="grid gap-4 md:grid-cols-3">
          <div class="card bg-base-100 shadow">
            <div class="card-body">
              <p class="text-sm text-base-content/70">Year to date</p>
              <h3 class="text-2xl font-semibold">
                {{ summary.currency }} {{ "%.2f"|format(summary.ytd) }}
              </h3>
              <p class="text-xs text-base-content/60">
                {{ summary.ytd_start }} â†’ {{ summary.today }}
              </p>
            </div>
          </div>
          <div class="card bg-base-100 shadow">
            <div class="card-body">
              <p class="text-sm text-base-content/70">Month to date</p>
              <h3 class="text-2xl font-semibold">
                {{ summary.currency }} {{ "%.2f"|format(summary.mtd) }}
              </h3>
              <p class="text-xs text-base-content/60">
                {{ summary.mtd_start }} â†’ {{ summary.today }}
              </p>
            </div>
          </div>
          <div class="card bg-base-100 shadow">
            <div class="card-body">
              <p class="text-sm text-base-content/70">Current week</p>
              <h3 class="text-2xl font-semibold">
                {{ summary.currency }} {{ "%.2f"|format(summary.week) }}
              </h3>
              <p class="text-xs text-base-content/60">
                {{ summary.week_start }} â†’ {{ summary.today }}
              </p>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% endif %}

  <div class="card bg-base-100 shadow mb-6">
    <div class="card-body space-y-4">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="card-title">Monthly performance</h2>
          <p class="text-sm text-base-content/70">Units (bars) vs. sales (line) for the year.</p>
        </div>
        <div class="join join-sm">
          <button class="btn btn-sm join-item btn-primary channel-toggle" data-channel="US">US ðŸ‡ºðŸ‡¸</button>
          <button class="btn btn-sm join-item btn-outline channel-toggle" data-channel="CANADA">Canada ðŸ‡¨ðŸ‡¦</button>
        </div>
      </div>
      <div class="h-72">
        <canvas id="channelChart" class="w-full h-full"></canvas>
      </div>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-4 space-y-2">
        {% for category, message in messages %}
          <div class="alert {{ 'alert-error' if category == 'error' else 'alert-success' }}">
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="space-y-6">
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h2 class="card-title">Brand dashboard</h2>
            <p class="text-sm text-base-content/70">Quick links and stats for {{ brand.name }}.</p>
          </div>
          <div class="join join-sm">
            <button
              class="report-toggle btn btn-sm join-item btn-primary"
              hx-get="{{ url_for('brand_reports', brand_id=brand.id, partial=1) }}"
              hx-target="#report-panel"
              hx-swap="innerHTML"
            >
              Monthly
            </button>
            <button
              class="report-toggle btn btn-sm join-item btn-outline"
              hx-get="{{ url_for('brand_weekly_reports', brand_id=brand.id, partial=1) }}"
              hx-target="#report-panel"
              hx-swap="innerHTML"
            >
              Weekly
            </button>
          </div>
        </div>

        <div id="report-panel" hx-get="{{ url_for('brand_reports', brand_id=brand.id, partial=1) }}" hx-trigger="load" hx-swap="innerHTML">
          <div class="text-sm text-base-content/70">Loading reportâ€¦</div>
        </div>
      </div>
    </div>
  </div>

  <dialog id="importDialog" class="modal">
    <div class="modal-box max-w-xl">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
      </form>
      <h3 class="font-bold text-lg mb-2">Import orders report</h3>
      <p class="text-sm text-base-content/70 mb-4">
        Upload a CSV or TXT orders report for this brand. The data will be imported into
        the SQLite database, and the original file will be archived.
      </p>
      <form
        method="post"
        action="{{ url_for('import_orders_report', brand_id=brand.id) }}"
        enctype="multipart/form-data"
        class="space-y-4"
      >
        <label class="form-control w-full">
          <div class="label">
            <span class="label-text font-semibold">Orders report (.csv or .txt)</span>
          </div>
          <input
            type="file"
            name="report_file"
            accept=".csv,text/csv,.txt,text/plain"
            class="file-input file-input-bordered w-full"
            required
          >
        </label>
        <div class="modal-action">
          <button type="button" class="btn btn-ghost" onclick="importDialog.close()">Cancel</button>
          <button class="btn btn-primary" type="submit">
            Import report
          </button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('htmx:afterSwap', function(evt) {
    if (!evt.target || evt.target.id !== 'report-panel') return;
    const buttons = document.querySelectorAll('.report-toggle');
    const isWeekly = evt.detail.xhr.responseURL && evt.detail.xhr.responseURL.includes('/reports/weekly');
    buttons.forEach(btn => {
      const wantsWeekly = btn.textContent.trim().toLowerCase() === 'weekly';
      if (wantsWeekly === isWeekly) {
        btn.classList.add('btn-primary');
        btn.classList.remove('btn-outline');
      } else {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline');
      }
    });
  });

  (function initChannelChart() {
    const chartCtx = document.getElementById('channelChart');
    if (!chartCtx) return;

    const chartData = {{ channel_chart_data|tojson }};
    const labels = chartData?.labels || [];
    const currentYear = chartData?.year;
    const previousYear = chartData?.previous_year;
    const channels = chartData?.channels || {};
    const defaultChannel = channels["US"] ? "US" : Object.keys(channels)[0] || "US";

    let chartInstance = null;

    function datasetFor(channelKey) {
      const data = channels[channelKey] || {
        units: Array(labels.length).fill(0),
        sales: Array(labels.length).fill(0),
        previous_sales: Array(labels.length).fill(0),
      };
      return {
        units: data.units,
        sales: data.sales,
        previousSales: data.previous_sales,
      };
    }

    function render(channelKey) {
      const data = datasetFor(channelKey);
      if (!chartInstance) {
        chartInstance = new Chart(chartCtx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                type: 'bar',
                label: `Units${currentYear ? ` (${currentYear})` : ''}`,
                data: data.units,
                backgroundColor: 'rgba(59, 130, 246, 0.4)',
                borderColor: 'rgba(37, 99, 235, 1)',
                borderWidth: 1,
                yAxisID: 'yUnits',
              },
              {
                type: 'line',
                label: `Sales${currentYear ? ` (${currentYear})` : ''}`,
                data: data.sales,
                borderColor: 'rgba(16, 185, 129, 1)',
                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                tension: 0.3,
                fill: false,
                yAxisID: 'ySales',
              },
              {
                type: 'line',
                label: `Sales${previousYear ? ` (${previousYear})` : ' (prev year)'}`,
                data: data.previousSales,
                borderColor: 'rgba(156, 163, 175, 1)',
                backgroundColor: 'rgba(156, 163, 175, 0.15)',
                borderDash: [6, 4],
                tension: 0.3,
                fill: false,
                yAxisID: 'ySales',
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: {
              yUnits: {
                type: 'linear',
                position: 'left',
                title: { display: true, text: 'Units' },
              },
              ySales: {
                type: 'linear',
                position: 'right',
                title: { display: true, text: 'Sales' },
                grid: { drawOnChartArea: false },
              },
            },
            plugins: {
              legend: { position: 'bottom' },
            },
          },
        });
      } else {
        chartInstance.data.datasets[0].data = data.units;
        chartInstance.data.datasets[1].data = data.sales;
        chartInstance.data.datasets[2].data = data.previousSales;
        chartInstance.update();
      }
    }

    function setActive(channelKey) {
      document.querySelectorAll('.channel-toggle').forEach((btn) => {
        const isActive = btn.dataset.channel === channelKey;
        btn.classList.toggle('btn-primary', isActive);
        btn.classList.toggle('btn-outline', !isActive);
      });
      render(channelKey);
    }

    document.querySelectorAll('.channel-toggle').forEach((btn) => {
      btn.addEventListener('click', () => setActive(btn.dataset.channel));
    });

    setActive(defaultChannel);
  })();
</script>
{% endblock %}
{% endblock %}
